name: Deploy RDxClaw (SCP + SSH)
on:
  push:
    branches: [ main ]
permissions:
  contents: read
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Build
      run: make generate && make build
    
    - name: SCP Binary
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "build/rdxclaw-linux-amd64"
        target: "/tmp/"
        overwrite: true

    - name: Deploy & Start
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "=== CLEANUP ==="
          rm -rf ~/rdxclaw* || true
          pkill -f rdxclaw || true
          sleep 2

          echo "=== FIND BINARY ==="
          BINARY_PATH=$(find /tmp -name rdxclaw-linux-amd64 -type f | head -1)
          [ -n "$BINARY_PATH" ] || { echo "❌ Binary missing"; find /tmp -name "*rdx*"; exit 1; }
          echo "✅ Found: $BINARY_PATH"
          file "$BINARY_PATH"

          echo "=== DEPLOY ==="
          mv "$BINARY_PATH" ~/rdxclaw
          chmod +x ~/rdxclaw
          ls -la ~/rdxclaw

          echo "=== PREP CONFIG ==="
          mkdir -p ~/.config/rdxclaw
          echo '{"first_run": true}' > ~/.config/rdxclaw/config.json

          echo "=== START RDxClaw ==="
          nohup ~/rdxclaw > ~/rdxclaw.log 2>&1 &
          RDX_PID=$!
          echo "Started PID: $RDX_PID"
          sleep 15

          echo "=== HEALTH CHECK ==="
          if ps -p $RDX_PID > /dev/null 2>&1; then
            echo "✅ LIVE! PID: $RDX_PID"
            ps aux | grep rdxclaw | grep -v grep | head -2
            echo "--- LOGS ---"
            tail -n 20 ~/rdxclaw.log
          else
            echo "⚠️ EXITED (normal for first run). Check logs:"
            cat ~/rdxclaw.log
            echo "Manual check: ssh $USER@$HOSTNAME 'tail -f ~/rdxclaw.log'"
          fi
